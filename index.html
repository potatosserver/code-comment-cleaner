<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ™ºæ…§å‹å¤šèªè¨€ç¨‹å¼ç¢¼ç·¨è¼¯å™¨ (å·®ç•°é è¦½ç‰ˆ)</title>
    <style>
        :root {
            --bg-color: #1e1e1e; --activity-bar-bg: #333333; --sidebar-bg: #252526;
            --editor-bg: #1e1e1e; --border-color: #444444; --text-color: #cccccc;
            --icon-active-bg: #3f3f46; --icon-active-border: #007acc; --item-hover-bg: #2a2d2e;
            --item-active-bg: #37373d; --button-bg: #007acc; --button-hover-bg: #005a9e;
            --button-danger-bg: #c0392b;
        }
        html, body { margin: 0; padding: 0; height: 100vh; width: 100vw; overflow: hidden; font-family: 'Segoe UI', sans-serif; background-color: var(--bg-color); color: var(--text-color); }
        .app-container { display: flex; height: 100%; }
        .activity-bar { width: 50px; background-color: var(--activity-bar-bg); border-right: 1px solid var(--border-color); flex-shrink: 0; display: flex; flex-direction: column; align-items: center; padding-top: 10px; z-index: 10; }
        .activity-icon { width: 100%; padding: 12px 0; font-size: 24px; text-align: center; cursor: pointer; position: relative; }
        .activity-icon:hover { background-color: var(--icon-active-bg); }
        .activity-icon.active { color: white; }
        .activity-icon.active::before { content: ''; position: absolute; left: 0; top: 5px; bottom: 5px; width: 2px; background-color: var(--icon-active-border); }
        .sidebar-container { width: 250px; background-color: var(--sidebar-bg); display: flex; flex-direction: column; transition: width 0.2s ease-out; flex-shrink: 0; }
        .sidebar-container.hidden { width: 0; opacity: 0; overflow: hidden; }
        .sidebar-header { padding: 10px 15px; font-size: 11px; font-weight: 600; text-transform: uppercase; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; flex-shrink: 0; }
        .sidebar-controls .icon-btn { cursor: pointer; font-size: 16px; }
        #file-list { list-style: none; padding: 0; margin: 0; overflow-y: auto; flex-grow: 1; }
        .file-item { padding: 8px 15px; font-size: 14px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #303030; }
        .file-item:hover { background-color: var(--item-hover-bg); }
        .file-item.active { background-color: var(--item-active-bg); }
        .delete-file-btn { color: #ccc; padding: 2px 4px; border-radius: 3px; font-weight: bold; }
        .delete-file-btn:hover { background-color: var(--button-danger-bg); color: white; }
        .main-content-container { flex-grow: 1; display: flex; flex-direction: column; min-width: 0; }
        .toolbar { display: flex; justify-content: flex-end; align-items: center; padding: 8px 20px; background-color: var(--editor-bg); flex-shrink: 0; gap: 15px; }
        #language-info, #status-info { font-size: 14px; padding: 5px 10px; background-color: var(--sidebar-bg); border-radius: 4px; }
        #status-info { color: #8cc25a; opacity: 0; transition: opacity 0.5s ease-in-out; }
        .action-button { background-color: var(--button-bg); color: white; border: none; padding: 8px 15px; font-size: 14px; border-radius: 4px; cursor: pointer; transition: background-color 0.2s; }
        .action-button:hover { background-color: var(--button-hover-bg); }
        #editor-container { width: 100%; flex-grow: 1; }

        /* --- å·®ç•°é è¦½å½ˆå‡ºè¦–çª—æ¨£å¼ --- */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.7); display: none; justify-content: center; align-items: center; z-index: 1000; }
        .modal-content { background-color: #2d2d2d; border-radius: 8px; width: 90%; height: 85%; display: flex; flex-direction: column; box-shadow: 0 5px 15px rgba(0,0,0,0.5); }
        .modal-header { padding: 10px 20px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border-color); }
        .modal-title { font-size: 18px; font-weight: 600; }
        .modal-actions button { margin-left: 10px; }
        .modal-body { flex-grow: 1; min-height: 0; }
        #diff-editor-container { width: 100%; height: 100%; }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- ä»‹é¢å…ƒç´ ... -->
        <div class="activity-bar"><div class="activity-icon active" id="files-icon" title="æª”æ¡ˆç¸½ç®¡">ğŸ“„</div></div>
        <div class="sidebar-container" id="sidebar">
            <div class="sidebar-header"><span>EXPLORER</span><div class="sidebar-controls"><span class="icon-btn" id="add-file-btn" title="æ–°å¢æª”æ¡ˆ">â•</span></div></div><ul id="file-list"></ul>
        </div>
        <div class="main-content-container">
            <div class="toolbar"><div id="status-info"></div><div id="language-info">èªè¨€ï¼šN/A</div><button class="action-button" id="preview-remove-btn">é è¦½è¨»è§£ç§»é™¤</button></div>
            <div id="editor-container"></div>
        </div>
    </div>

    <!-- å·®ç•°é è¦½å½ˆå‡ºè¦–çª— HTML -->
    <div class="modal-overlay" id="diff-modal">
        <div class="modal-content">
            <div class="modal-header">
                <span class="modal-title">é è¦½è®Šæ›´ (å·¦:åŸå§‹, å³:ç§»é™¤å¾Œ)</span>
                <div class="modal-actions">
                    <button class="action-button" id="apply-changes-btn">ç¢ºèªä¸¦å¥—ç”¨è®Šæ›´</button>
                    <button class="action-button" id="cancel-changes-btn" style="background-color: var(--button-danger-bg);">å–æ¶ˆ</button>
                </div>
            </div>
            <div class="modal-body"><div id="diff-editor-container"></div></div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.44.0/min/vs/loader.min.js"></script>
    <script>
        let editor, diffEditor;
        let currentOpenFile = 'script.js';
        let isSidebarVisible = true;
        let cleanedCodeCache = '';
        const fileStore = { /* ... æª”æ¡ˆå…§å®¹èˆ‡ä¹‹å‰ç›¸åŒ ... */ };

        // --- å·®ç•°é è¦½è¦–çª—é‚è¼¯ ---
        const diffModal = document.getElementById('diff-modal');
        const applyBtn = document.getElementById('apply-changes-btn');
        const cancelBtn = document.getElementById('cancel-changes-btn');

        function showDiffModal(originalCode, cleanedCode, lang) {
            diffModal.style.display = 'flex';
            if (!diffEditor) {
                diffEditor = monaco.editor.createDiffEditor(document.getElementById('diff-editor-container'), { theme: 'vs-dark', readOnly: false, enableSplitViewResizing: true });
            }
            const originalModel = monaco.editor.createModel(originalCode, lang);
            const cleanedModel = monaco.editor.createModel(cleanedCode, lang);
            diffEditor.setModel({ original: originalModel, modified: cleanedModel });
            cleanedCodeCache = cleanedCode; // å¿«å–æ¸…ç†å¾Œçš„ç¨‹å¼ç¢¼
        }

        function closeDiffModal() {
            diffModal.style.display = 'none';
        }

        applyBtn.addEventListener('click', () => {
            editor.setValue(cleanedCodeCache);
            closeDiffModal();
            showStatus('âœ… è®Šæ›´å·²æˆåŠŸå¥—ç”¨ï¼', 3000);
        });
        cancelBtn.addEventListener('click', closeDiffModal);

        // --- â˜…â˜…â˜… ä½¿ç”¨ Monaco å…§æ ¸çš„ç§»é™¤åŠŸèƒ½ï¼Œåªç”¢ç”Ÿçµæœï¼Œä¸ç›´æ¥ä¿®æ”¹ â˜…â˜…â˜… ---
        function generateCleanedCode(model) {
            const languageId = model.getLanguageId();
            const originalLines = model.getLinesContent();
            let modifiedLines = [...originalLines];
            
            const tokenLines = monaco.editor.tokenize(model.getValue(), languageId);
            let hasComments = false;

            for (let i = tokenLines.length - 1; i >= 0; i--) {
                let lineContent = modifiedLines[i];
                for (let j = tokenLines[i].length - 1; j >= 0; j--) {
                    if (tokenLines[i][j].type.includes('comment')) {
                        hasComments = true;
                        const token = tokenLines[i][j];
                        const endOffset = (j + 1 < tokenLines[i].length) ? tokenLines[i][j + 1].offset : lineContent.length;
                        lineContent = lineContent.substring(0, token.offset) + lineContent.substring(endOffset);
                    }
                }
                modifiedLines[i] = lineContent;
            }
            
            if (!hasComments) return null; // å¦‚æœæ²’æœ‰æ‰¾åˆ°è¨»è§£ï¼Œè¿”å› null
            return modifiedLines.filter(line => line.trim() !== '').join('\n');
        }

        function previewAndRemoveComments() {
            if (!editor || !currentOpenFile) return;
            const model = editor.getModel();
            const cleanedCode = generateCleanedCode(model);

            if (cleanedCode !== null) {
                showDiffModal(editor.getValue(), cleanedCode, model.getLanguageId());
            } else {
                showStatus('â„¹ï¸ åœ¨æ­¤æª”æ¡ˆä¸­æœªæ‰¾åˆ°ä»»ä½•å¯ç§»é™¤çš„è¨»è§£ã€‚', 3000);
            }
        }
        
        // --- æ¨™æº– UI é‚è¼¯ (æ­¤è™•çœç•¥ï¼Œèˆ‡ä¹‹å‰ç‰ˆæœ¬ç›¸åŒ) ---
        // (ç‚ºäº†ç°¡æ½”ï¼Œé€™è£¡ä¸é‡è¤‡è²¼ä¸Šï¼Œå®ƒå€‘èˆ‡ä¹‹å‰ç‰ˆæœ¬å®Œå…¨ä¸€æ¨£)
        const sidebar = document.getElementById('sidebar');
        const filesIcon = document.getElementById('files-icon');
        const statusInfo = document.getElementById('status-info');
        let statusTimeout;
        fileStore['index.html'] = `<!-- é»æ“Šå³ä¸Šè§’çš„æŒ‰éˆ•è©¦è©¦ï¼ -->\n<!DOCTYPE html>\n<html><body>\n    <p>å­—ä¸²ä¸­çš„æ¨™ç±¤: "<!-- é€™ä¸è©²è¢«ç§»é™¤ -->"</p>\n    <!-- é€™æ˜¯ä¸€å€‹çœŸæ­£çš„è¨»è§£ -->\n</body></html>`;
        fileStore['script.js'] = `// é€™æ˜¯ä¸€å€‹ JavaScript æª”æ¡ˆ\n\nfunction calculate() {\n    const url = "http://example.com"; // é€™ä¸æ˜¯è¨»è§£ï¼Œä¸è©²ç§»é™¤\n    const text = "å­—ä¸²è£¡çš„ // è¨»è§£ç¬¦è™Ÿ";\n    \n    /* é€™æ˜¯ä¸€å€‹çœŸæ­£çš„\n       å¤šè¡Œè¨»è§£ */\n    return 1 + 1; \n}\n`;
        fileStore['styles.css'] = `/* CSS æª”æ¡ˆç¯„ä¾‹ */\n\n.container {\n    /* é€™æ˜¯è¨»è§£ */\n    content: "/* é€™ä¸æ˜¯è¨»è§£ */";\n}`;
        function toggleSidebar() { isSidebarVisible = !isSidebarVisible; sidebar.classList.toggle('hidden', !isSidebarVisible); filesIcon.classList.toggle('active', isSidebarVisible); if (editor) editor.layout(); if (diffEditor) diffEditor.layout(); }
        function showStatus(message, duration = 3000) { clearTimeout(statusTimeout); statusInfo.textContent = message; statusInfo.style.opacity = '1'; statusTimeout = setTimeout(() => { statusInfo.style.opacity = '0'; }, duration); }
        function getLanguageFromFilename(filename) { const extension = filename ? filename.split('.').pop() : ''; const langMap = { js: 'javascript', ts: 'typescript', css: 'css', html: 'html', json: 'json', md: 'markdown', py: 'python', java: 'java', cs: 'csharp', cpp: 'cpp', sql: 'sql' }; return langMap[extension] || 'plaintext'; }
        function renderFileExplorer() { const fileList = document.getElementById('file-list'); fileList.innerHTML = ''; Object.keys(fileStore).sort().forEach(filename => { const li = document.createElement('li'); li.className = 'file-item'; if (filename === currentOpenFile) li.classList.add('active'); li.addEventListener('click', () => openFile(filename)); const fileNameSpan = document.createElement('span'); fileNameSpan.textContent = filename; const deleteBtn = document.createElement('span'); deleteBtn.textContent = 'x'; deleteBtn.className = 'delete-file-btn'; deleteBtn.title = `åˆªé™¤ ${filename}`; deleteBtn.onclick = (e) => { e.stopPropagation(); deleteFile(filename); }; li.appendChild(fileNameSpan); li.appendChild(deleteBtn); fileList.appendChild(li); }); }
        function openFile(filename) { if (filename === null || !fileStore.hasOwnProperty(filename)) { currentOpenFile = null; editor.setValue(''); monaco.editor.setModelLanguage(editor.getModel(), 'plaintext'); document.getElementById('language-info').textContent = 'èªè¨€ï¼šN/A'; renderFileExplorer(); return; } currentOpenFile = filename; const lang = getLanguageFromFilename(filename); editor.setValue(fileStore[filename]); monaco.editor.setModelLanguage(editor.getModel(), lang); document.getElementById('language-info').textContent = 'èªè¨€ï¼š' + lang; renderFileExplorer(); }
        function addNewFile() { const filename = prompt("è«‹è¼¸å…¥æ–°æª”å:"); if (filename && filename.trim() !== '') { if (!fileStore.hasOwnProperty(filename)) { fileStore[filename] = `// æ–°æª”æ¡ˆ: ${filename}\n`; openFile(filename); showStatus(`âœ… å·²å»ºç«‹æª”æ¡ˆ ${filename}`); } else { alert("éŒ¯èª¤ï¼šæª”æ¡ˆåç¨±å·²å­˜åœ¨ï¼"); } } }
        function deleteFile(filename) { if (confirm(`ç¢ºå®šè¦åˆªé™¤æª”æ¡ˆ "${filename}" å—ï¼Ÿ`)) { delete fileStore[filename]; showStatus(`ğŸ—‘ï¸ å·²åˆªé™¤æª”æ¡ˆ ${filename}`); if (currentOpenFile === filename) { const remainingFiles = Object.keys(fileStore); openFile(remainingFiles.length > 0 ? remainingFiles[0] : null); } else { renderFileExplorer(); } } }

        // --- åˆå§‹åŒ– ---
        require.config({ paths: { 'vs': 'https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.44.0/min/vs' }});
        require(['vs/editor/editor.main'], function() {
            editor = monaco.editor.create(document.getElementById('editor-container'), { theme: 'vs-dark', automaticLayout: true, fontSize: 14, wordWrap: 'on', minimap: { enabled: true }, fontFamily: 'Consolas, "Courier New", monospace' });
            editor.getModel().onDidChangeContent(() => { if (currentOpenFile) { fileStore[currentOpenFile] = editor.getValue(); } });
            filesIcon.addEventListener('click', toggleSidebar);
            document.getElementById('add-file-btn').addEventListener('click', addNewFile);
            document.getElementById('preview-remove-btn').addEventListener('click', previewAndRemoveComments);
            openFile(currentOpenFile);
        });
    </script>
</body>
</html>