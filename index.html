<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>智慧型多語言程式碼編輯器 (Material 3 風格)</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&family=Roboto+Mono:wght@400&display=swap" rel="stylesheet">
    <style>
        :root {
            /* Material 3 Dark Theme Color Palette */
            --md-sys-color-primary: #a8c7fa;
            --md-sys-color-on-primary: #003366;
            --md-sys-color-primary-container: #004a94;
            --md-sys-color-on-primary-container: #d6e3ff;
            --md-sys-color-error: #f2b8b5;
            --md-sys-color-on-error: #601410;
            --md-sys-color-background: #1a1c1e;
            --md-sys-color-on-background: #e3e2e6;
            --md-sys-color-surface: #1a1c1e;
            --md-sys-color-on-surface: #e3e2e6;
            --md-sys-color-surface-variant: #44474e;
            --md-sys-color-on-surface-variant: #c4c6d0;
            --md-sys-color-outline: #8e9199;
            --md-sys-color-surface-container-highest: #333538;
            --md-sys-color-surface-container-high: #282a2d;
            --md-sys-color-surface-container: #242629;
        }

        html, body {
            margin: 0; padding: 0; height: 100vh; width: 100vw; overflow: hidden;
            font-family: 'Roboto', sans-serif;
            background-color: var(--md-sys-color-background);
            color: var(--md-sys-color-on-background);
        }

        body.resizing {
            cursor: col-resize;
            user-select: none;
        }

        .app-container { display: flex; height: 100%; }

        .activity-bar {
            width: 56px;
            background-color: var(--md-sys-color-surface-container);
            flex-shrink: 0;
            display: flex; flex-direction: column; align-items: center;
            padding-top: 16px; gap: 16px;
        }
        .activity-icon {
            width: 48px; height: 48px; font-size: 24px;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; position: relative; border-radius: 50%;
            transition: background-color 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .activity-icon:hover { background-color: var(--md-sys-color-surface-variant); }
        .activity-icon.active {
            background-color: var(--md-sys-color-primary-container);
            color: var(--md-sys-color-on-primary-container);
        }

        .sidebar-container {
            width: 280px; min-width: 180px; max-width: 50%;
            background-color: var(--md-sys-color-surface-container-high);
            display: flex; flex-direction: column;
            transition: width 0.25s ease-out, min-width 0.25s ease-out, opacity 0.25s ease-out;
            flex-shrink: 0; position: relative;
        }
        .sidebar-container.no-transition { transition: none; }
        .sidebar-container.hidden {
            width: 0 !important; min-width: 0 !important;
            opacity: 0; border-right: none; overflow: hidden;
        }

        #drop-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0, 74, 148, 0.7);
            display: none; justify-content: center; align-items: center;
            font-size: 18px; font-weight: 500;
            color: var(--md-sys-color-on-primary-container);
            pointer-events: none; z-index: 10;
        }

        #resizer {
            width: 4px; background-color: var(--md-sys-color-outline);
            cursor: col-resize; flex-shrink: 0; transition: background-color 0.2s;
        }
        #resizer:hover { background-color: var(--md-sys-color-primary); }

        .sidebar-header {
            padding: 16px; font-size: 14px; font-weight: 500;
            display: flex; justify-content: space-between; align-items: center;
            flex-shrink: 0; letter-spacing: 0.1px;
            color: var(--md-sys-color-on-surface-variant);
            border-bottom: 1px solid var(--md-sys-color-outline);
        }
        .sidebar-controls .icon-btn {
            cursor: pointer; font-size: 22px; width: 40px; height: 40px;
            display: flex; align-items: center; justify-content: center;
            border-radius: 50%; transition: background-color 0.2s;
            color: var(--md-sys-color-on-surface-variant);
        }
        .sidebar-controls .icon-btn:hover { background-color: var(--md-sys-color-surface-variant); }

        #file-list { list-style: none; padding: 8px 0; margin: 0; overflow-y: auto; flex-grow: 1; }
        
        .file-item {
            padding: 0 8px 0 16px;
            height: 48px; font-size: 14px; cursor: pointer;
            display: flex; justify-content: space-between; align-items: center;
            border-radius: 24px; margin: 0 8px; transition: background-color 0.2s;
            gap: 8px;
        }
        .file-name-text {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            flex-grow: 1;
            min-width: 0;
        }
        .delete-file-btn {
            color: var(--md-sys-color-on-surface-variant);
            width: 32px; height: 32px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center; font-weight: bold;
            flex-shrink: 0;
        }
        .file-item:hover { background-color: var(--md-sys-color-surface-variant); }
        .file-item.active { background-color: var(--md-sys-color-primary-container); color: var(--md-sys-color-on-primary-container); }
        .delete-file-btn:hover { background-color: var(--md-sys-color-error); color: var(--md-sys-color-on-error); }
        
        .main-content-container { flex-grow: 1; display: flex; flex-direction: column; min-width: 0; }
        #welcome-screen {
            flex-grow: 1; display: flex; flex-direction: column;
            justify-content: center; align-items: center;
            gap: 20px; color: var(--md-sys-color-on-surface-variant); text-align: center;
        }
        #welcome-screen h2 { font-size: 24px; font-weight: 500; color: var(--md-sys-color-on-surface); }

        .toolbar {
            display: flex; justify-content: flex-end; align-items: center; padding: 8px 16px;
            background-color: var(--md-sys-color-surface-container-high);
            flex-shrink: 0; gap: 12px; border-bottom: 1px solid var(--md-sys-color-outline);
        }
        #language-info, #status-info {
            font-size: 14px; padding: 6px 12px; border-radius: 8px;
            background-color: var(--md-sys-color-surface-container); color: var(--md-sys-color-on-surface-variant);
        }
        #status-info { color: #81c784; opacity: 0; transition: opacity 0.5s ease-in-out; }

        .action-button {
            background-color: var(--md-sys-color-primary); color: var(--md-sys-color-on-primary);
            border: none; padding: 10px 24px; font-size: 14px; font-weight: 500;
            border-radius: 20px; cursor: pointer; transition: background-color 0.2s, box-shadow 0.2s;
            height: 40px; display: flex; align-items: center; justify-content: center;
            box-shadow: 0 1px 2px rgba(0,0,0,0.3); text-decoration: none; 
        }
        .action-button:hover { box-shadow: 0 2px 4px rgba(0,0,0,0.3); background-color: #b9d3f9; }
        .action-button.outlined { background-color: transparent; border: 1px solid var(--md-sys-color-outline); color: var(--md-sys-color-primary); box-shadow: none; }
        .action-button.outlined:hover { background-color: var(--md-sys-color-surface-variant); box-shadow: none; }
        .action-button.text-button { background-color: transparent; color: var(--md-sys-color-primary); box-shadow: none; padding: 10px 12px; height: auto; border-radius: 10px; }
        .action-button.text-button:hover { background-color: var(--md-sys-color-surface-variant); box-shadow: none; }

        #editor-container { width: 100%; flex-grow: 1; display: none; }

        /* --- Styles for Modals, Text Inputs etc. (unchanged) --- */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.5); display: none; justify-content: center; align-items: center; z-index: 1000; }
        .modal-content { background-color: var(--md-sys-color-surface-container-highest); border-radius: 28px; width: 90%; height: 85%; display: flex; flex-direction: column; box-shadow: 0 8px 24px rgba(0,0,0,0.4); overflow: hidden; max-width: 1000px; }
        #add-file-modal .modal-content { width: 400px; height: auto; padding: 24px; gap: 16px; }
        #add-file-modal .modal-header { padding: 0; border-bottom: none; }
        #add-file-modal .modal-body { padding: 0; }
        #add-file-modal .modal-actions { justify-content: flex-end; width: 100%; padding-top: 16px; }
        .modal-header { padding: 24px; display: flex; justify-content: space-between; align-items: center; flex-shrink: 0; }
        .modal-title { font-size: 22px; line-height: 28px; font-weight: 400; color: var(--md-sys-color-on-surface); }
        .modal-actions { display: flex; gap: 8px; }
        .modal-body { flex-grow: 1; min-height: 0; padding: 0 24px 24px; }
        #diff-editor-container { width: 100%; height: 100%; border-radius: 12px; overflow: hidden;}
        .text-input-container { position: relative; width: 100%; margin-top: 8px; }
        .text-input { width: 100%; padding: 16px 16px 12px; border: 1px solid var(--md-sys-color-outline); border-radius: 8px; background-color: var(--md-sys-color-surface-container); color: var(--md-sys-color-on-surface); font-size: 16px; outline: none; transition: border-color 0.2s ease-in-out, background-color 0.2s ease-in-out; box-sizing: border-box; }
        .text-input:focus { border-color: var(--md-sys-color-primary); box-shadow: 0 0 0 1px var(--md-sys-color-primary); }
        .text-input::placeholder { color: var(--md-sys-color-on-surface-variant); opacity: 0.7; }
        .text-input-label { position: absolute; left: 16px; top: 16px; color: var(--md-sys-color-on-surface-variant); pointer-events: none; transition: all 0.2s ease-in-out; font-size: 16px; background-color: var(--md-sys-color-surface-container); padding: 0 4px; }
        .text-input:focus + .text-input-label, .text-input:not(:placeholder-shown) + .text-input-label { top: -10px; font-size: 12px; color: var(--md-sys-color-primary); background-color: var(--md-sys-color-surface-container-highest); }
        .text-input-error { color: var(--md-sys-color-error); font-size: 12px; margin-top: 4px; margin-left: 16px; display: none; }
        .text-input.error { border-color: var(--md-sys-color-error); box-shadow: 0 0 0 1px var(--md-sys-color-error); }
        .text-input.error + .text-input-label { color: var(--md-sys-color-error); }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Activity Bar -->
        <div class="activity-bar">
            <div class="activity-icon active" id="files-icon" title="檔案總管">📄</div>
        </div>
        <!-- Sidebar -->
        <div class="sidebar-container" id="sidebar">
            <div id="drop-overlay">拖曳檔案至此處</div>
            <div class="sidebar-header">
                <span>EXPLORER</span>
                <div class="sidebar-controls">
                    <span class="icon-btn" id="add-file-btn" title="新增檔案">➕</span>
                </div>
            </div>
            <ul id="file-list"></ul>
        </div>
        <!-- Resizer Handle -->
        <div id="resizer"></div>
        <!-- Main Content -->
        <div class="main-content-container">
            <div class="toolbar">
                <div id="status-info"></div>
                <div id="language-info">語言：N/A</div>
                <button class="action-button" id="preview-remove-btn">預覽註解移除</button>
            </div>
            <div id="editor-container"></div>
            <div id="welcome-screen">
                <h2>歡迎使用程式碼編輯器</h2>
                <p>左側沒有檔案，請建立或拖曳檔案至此處。</p>
                <button class="action-button" id="create-file-welcome-btn">建立新檔案</button>
            </div>
        </div>
    </div>

    <!-- Modals (unchanged HTML) -->
    <div class="modal-overlay" id="diff-modal"><div class="modal-content"><div class="modal-header"><span class="modal-title">預覽變更 (左:原始, 右:移除後)</span><div class="modal-actions"><button class="action-button outlined" id="cancel-changes-btn">取消</button><button class="action-button" id="apply-changes-btn">確認並套用</button></div></div><div class="modal-body"><div id="diff-editor-container"></div></div></div></div>
    <div class="modal-overlay" id="add-file-modal"><div class="modal-content"><div class="modal-header"><span class="modal-title">新增檔案</span></div><div class="modal-body" style="padding: 0;"><div class="text-input-container"><input type="text" id="new-filename-input" class="text-input" placeholder=" " autocomplete="off"><label for="new-filename-input" class="text-input-label">檔名</label><div id="new-filename-error" class="text-input-error"></div></div></div><div class="modal-actions"><button class="action-button text-button" id="cancel-add-file-btn">取消</button><button class="action-button" id="create-file-btn">建立</button></div></div></div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.44.0/min/vs/loader.min.js"></script>
    <script>
        let editor, diffEditor;
        let currentOpenFile = null;
        let isSidebarVisible = true;
        
        // --- Local Storage Logic ---
        const FILE_STORE_KEY = 'monacoEditorFileStore';
        const LAST_OPEN_FILE_KEY = 'monacoEditorLastOpenFile';
        const SIDEBAR_WIDTH_KEY = 'monacoEditorSidebarWidth';
        function loadFileStoreFromLocalStorage() { try { const stored = localStorage.getItem(FILE_STORE_KEY); return stored ? JSON.parse(stored) : {}; } catch (e) { console.error("無法解析本地儲存的檔案:", e); return {}; } }
        function saveFileStoreToLocalStorage() { localStorage.setItem(FILE_STORE_KEY, JSON.stringify(fileStore)); }
        let fileStore = loadFileStoreFromLocalStorage();

        // --- UI Elements ---
        const sidebar = document.getElementById('sidebar');
        const resizer = document.getElementById('resizer');
        const editorContainer = document.getElementById('editor-container');
        const welcomeScreen = document.getElementById('welcome-screen');
        const previewRemoveBtn = document.getElementById('preview-remove-btn');
        const dropOverlay = document.getElementById('drop-overlay');

        // --- Sidebar Resizing Logic ---
        const handleMouseDown = e => {
            e.preventDefault();
            document.body.classList.add('resizing');
            sidebar.classList.add('no-transition');
            const startX = e.clientX;
            const startWidth = sidebar.offsetWidth;
            const handleMouseMove = moveEvent => {
                const newWidth = startWidth + moveEvent.clientX - startX;
                const minWidth = parseInt(getComputedStyle(sidebar).minWidth);
                const maxWidth = window.innerWidth * 0.5;
                if (newWidth > minWidth && newWidth < maxWidth) {
                    sidebar.style.width = `${newWidth}px`;
                    if (editor) editor.layout();
                    if (diffEditor) diffEditor.layout();
                }
            };
            const handleMouseUp = () => {
                document.body.classList.remove('resizing');
                sidebar.classList.remove('no-transition');
                document.removeEventListener('mousemove', handleMouseMove);
                document.removeEventListener('mouseup', handleMouseUp);
                localStorage.setItem(SIDEBAR_WIDTH_KEY, sidebar.style.width);
            };
            document.addEventListener('mousemove', handleMouseMove);
            document.addEventListener('mouseup', handleMouseUp);
        };
        resizer.addEventListener('mousedown', handleMouseDown);

        // --- Drag and Drop File Logic ---
        sidebar.addEventListener('dragenter', (e) => { e.preventDefault(); e.stopPropagation(); sidebar.classList.add('drag-over'); dropOverlay.style.display = 'flex'; });
        sidebar.addEventListener('dragover', (e) => { e.preventDefault(); e.stopPropagation(); });
        sidebar.addEventListener('dragleave', (e) => { e.preventDefault(); e.stopPropagation(); sidebar.classList.remove('drag-over'); dropOverlay.style.display = 'none'; });
        sidebar.addEventListener('drop', (e) => {
            e.preventDefault(); e.stopPropagation();
            sidebar.classList.remove('drag-over'); dropOverlay.style.display = 'none';
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                let firstNewFile = null;
                Array.from(files).forEach((file, index) => {
                    const reader = new FileReader();
                    reader.onload = (readEvent) => {
                        const fileName = file.name;
                        const fileContent = readEvent.target.result;
                        if (fileStore.hasOwnProperty(fileName) && !confirm(`檔案 "${fileName}" 已存在。要覆蓋它嗎？`)) return;
                        if (!firstNewFile) firstNewFile = fileName;
                        fileStore[fileName] = fileContent;
                        if (index === files.length - 1) {
                            saveFileStoreToLocalStorage();
                            renderFileExplorer();
                            openFile(firstNewFile);
                            showStatus(`✅ 已成功匯入 ${files.length} 個檔案。`);
                        }
                    };
                    reader.readAsText(file);
                });
            }
        });

        // --- Core Application Logic ---
        const diffModal = document.getElementById('diff-modal');
        const applyBtn = document.getElementById('apply-changes-btn');
        const cancelBtn = document.getElementById('cancel-changes-btn');
        function showDiffModal(originalCode, cleanedCode, lang) { let cleanedCodeCache = cleanedCode; diffModal.style.display = 'flex'; if (!diffEditor) { diffEditor = monaco.editor.createDiffEditor(document.getElementById('diff-editor-container'), { theme: 'vs-dark', readOnly: false, enableSplitViewResizing: true, renderSideBySide: true, originalEditable: false, }); } const originalModel = monaco.editor.createModel(originalCode, lang); const cleanedModel = monaco.editor.createModel(cleanedCode, lang); diffEditor.setModel({ original: originalModel, modified: cleanedModel }); setTimeout(() => diffEditor.layout(), 10); applyBtn.onclick = () => { if(currentOpenFile) { editor.setValue(cleanedCodeCache); fileStore[currentOpenFile] = cleanedCodeCache; saveFileStoreToLocalStorage(); } closeDiffModal(); showStatus('✅ 變更已成功套用！', 3000); }; }
        function closeDiffModal() { diffModal.style.display = 'none'; }
        cancelBtn.addEventListener('click', closeDiffModal);
        function generateCleanedCode(model) { const langId=model.getLanguageId(),lines=model.getLinesContent(),modLines=[...lines],tokLines=monaco.editor.tokenize(model.getValue(),langId);let hasComments=!1;for(let i=tokLines.length-1;i>=0;i--){let line=modLines[i];for(let j=tokLines[i].length-1;j>=0;j--)tokLines[i][j].type.includes("comment")&&(hasComments=!0,line=line.substring(0,tokLines[i][j].offset)+line.substring((j+1<tokLines[i].length?tokLines[i][j+1].offset:line.length)));modLines[i]=line}return hasComments?modLines.filter(l=>l.trim()!=="").join("\n"):null }
        function previewAndRemoveComments() { if (!editor || !currentOpenFile) { showStatus('ℹ️ 請先選擇一個檔案來進行操作。', 3000); return; } const model = editor.getModel(); const cleanedCode = generateCleanedCode(model); if (cleanedCode !== null) { showDiffModal(editor.getValue(), cleanedCode, model.getLanguageId()); } else { showStatus('ℹ️ 在此檔案中未找到任何可移除的註解。', 3000); } }
        
        const addFileModal = document.getElementById('add-file-modal'), newFilenameInput = document.getElementById('new-filename-input'), newFilenameError = document.getElementById('new-filename-error'), createFileBtn = document.getElementById('create-file-btn'), cancelAddFileBtn = document.getElementById('cancel-add-file-btn');
        function showAddFileModal() { addFileModal.style.display = 'flex'; newFilenameInput.value = ''; newFilenameInput.classList.remove('error'); newFilenameError.style.display = 'none'; setTimeout(() => newFilenameInput.focus(), 100); }
        function closeAddFileModal() { addFileModal.style.display = 'none'; }
        
        // ★★★ UPDATED VALIDATION LOGIC ★★★
        function validateFilename(filename) {
            const trimmedFilename = filename.trim();

            if (trimmedFilename === '') {
                return '檔名不能為空。';
            }
            if (trimmedFilename === '.' || trimmedFilename === '..') {
                return '檔名不能為 "." 或 ".."。';
            }
            if (fileStore.hasOwnProperty(trimmedFilename)) {
                return '此檔名已存在。';
            }
            if (/[\\/:"*?<>|]/.test(trimmedFilename)) {
                return '檔名包含無效字元 (\\ / : * ? " < > |)。';
            }
            
            return null; // All checks passed
        }

        createFileBtn.addEventListener('click', () => {
            const filename = newFilenameInput.value; const error = validateFilename(filename);
            if (error) { newFilenameInput.classList.add('error'); newFilenameError.textContent = error; newFilenameError.style.display = 'block'; }
            else { const finalFilename = filename.trim(); fileStore[finalFilename] = `# ${finalFilename}\n`; saveFileStoreToLocalStorage(); openFile(finalFilename); showStatus(`✅ 已建立檔案 ${finalFilename}`); closeAddFileModal(); }
        });
        cancelAddFileBtn.addEventListener('click', closeAddFileModal);
        newFilenameInput.addEventListener('input', () => { if (newFilenameInput.classList.contains('error')) { newFilenameInput.classList.remove('error'); newFilenameError.style.display = 'none'; } });
        newFilenameInput.addEventListener('keydown', (e) => { if (e.key === 'Enter') createFileBtn.click(); });

        const filesIcon = document.getElementById('files-icon'), statusInfo = document.getElementById('status-info'); let statusTimeout;
        
        function toggleSidebar() { isSidebarVisible = !isSidebarVisible; sidebar.classList.toggle('hidden', !isSidebarVisible); resizer.style.display = isSidebarVisible ? 'block' : 'none'; filesIcon.classList.toggle('active', isSidebarVisible); setTimeout(() => { if (editor) editor.layout(); if (diffEditor) diffEditor.layout(); }, 250); }
        function showStatus(message, duration = 3000) { clearTimeout(statusTimeout); statusInfo.textContent = message; statusInfo.style.opacity = '1'; statusTimeout = setTimeout(() => { statusInfo.style.opacity = '0'; }, duration); }
        function getLanguageFromFilename(filename) { 
            if (filename.startsWith('.') && !filename.includes('/', 1)) {
                const lower = filename.toLowerCase();
                if (lower.endsWith('ignore')) return 'ignore';
                if (lower.endsWith('rc')) return 'json'; // e.g. .prettierrc, .babelrc
                if (lower.endsWith('env')) return 'dotenv';
            }
            const ext = filename.split('.').pop();
            const map = { js: 'javascript', ts: 'typescript', css: 'css', html: 'html', json: 'json', md: 'markdown', py: 'python', java: 'java', cs: 'csharp', cpp: 'cpp', sql: 'sql' }; return map[ext] || 'plaintext'; 
        }
        
        function truncateFilename(filename, maxLength = 25) {
            if (filename.length <= maxLength) {
                return filename;
            }
            const extIndex = filename.lastIndexOf('.');
            if (extIndex <= 0) {
                return filename.substring(0, maxLength - 3) + '...';
            }
            const basename = filename.substring(0, extIndex);
            const extension = filename.substring(extIndex);
            if (extension.length + 3 > maxLength) {
                const truncatedExt = extension.substring(extension.length - (maxLength - 3));
                return '...' + truncatedExt;
            }
            const availableBasenameLength = maxLength - extension.length - 3;
            const truncatedBasename = basename.substring(0, availableBasenameLength);
            return truncatedBasename + '...' + extension;
        }
        
        function renderFileExplorer() {
            const fileList = document.getElementById('file-list'); fileList.innerHTML = '';
            const filenames = Object.keys(fileStore).sort();
            if (filenames.length === 0) {
                const emptyMsg = document.createElement('li'); emptyMsg.style.cssText = "padding: 16px; font-size: 14px; color: var(--md-sys-color-on-surface-variant);";
                emptyMsg.textContent = '沒有檔案。點擊 "➕" 或拖曳檔案至此處。'; fileList.appendChild(emptyMsg);
            } else {
                filenames.forEach(filename => {
                    const li = document.createElement('li'); li.className = 'file-item';
                    if (filename === currentOpenFile) li.classList.add('active');
                    li.addEventListener('click', () => openFile(filename));
                    
                    const fileNameSpan = document.createElement('span');
                    fileNameSpan.className = 'file-name-text';
                    fileNameSpan.textContent = truncateFilename(filename);
                    fileNameSpan.title = filename;
                    
                    const deleteBtn = document.createElement('span'); deleteBtn.textContent = 'x'; deleteBtn.className = 'delete-file-btn'; deleteBtn.title = `刪除 ${filename}`;
                    deleteBtn.onclick = (e) => { e.stopPropagation(); deleteFile(filename); };
                    
                    li.appendChild(fileNameSpan);
                    li.appendChild(deleteBtn);
                    fileList.appendChild(li);
                });
            }
        }

        function openFile(filename) {
            if (filename === null || !fileStore.hasOwnProperty(filename)) {
                currentOpenFile = null; localStorage.removeItem(LAST_OPEN_FILE_KEY);
                editorContainer.style.display = 'none'; welcomeScreen.style.display = 'flex'; previewRemoveBtn.style.display = 'none';
                if (editor) { editor.setValue(''); monaco.editor.setModelLanguage(editor.getModel(), 'plaintext'); }
                document.getElementById('language-info').textContent = '語言：N/A';
            } else {
                currentOpenFile = filename; localStorage.setItem(LAST_OPEN_FILE_KEY, filename);
                editorContainer.style.display = 'block'; welcomeScreen.style.display = 'none'; previewRemoveBtn.style.display = 'flex';
                const lang = getLanguageFromFilename(filename);
                if (editor) { editor.setValue(fileStore[filename]); monaco.editor.setModelLanguage(editor.getModel(), lang); editor.focus(); }
                document.getElementById('language-info').textContent = '語言：' + lang.toUpperCase();
            }
            renderFileExplorer();
        }

        function addNewFile() { showAddFileModal(); }
        function deleteFile(filename) { if (confirm(`確定要刪除檔案 "${filename}" 嗎？`)) { delete fileStore[filename]; saveFileStoreToLocalStorage(); showStatus(`🗑️ 已刪除檔案 ${filename}`); if (currentOpenFile === filename) { const remaining = Object.keys(fileStore); openFile(remaining.length > 0 ? remaining[0] : null); } else { renderFileExplorer(); } } }

        // --- Initialization ---
        require.config({ paths: { 'vs': 'https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.44.0/min/vs' }});
        require(['vs/editor/editor.main'], function() {
            // Register a custom language for .env files if not built-in
            monaco.languages.register({ id: 'dotenv' });
            monaco.languages.setMonarchTokensProvider('dotenv', {
                tokenizer: {
                    root: [
                        [/^#.*$/, 'comment'],
                        [/^\s*[a-zA-Z_][\w-]*\s*=/, 'keyword'],
                    ]
                }
            });
             monaco.languages.register({ id: 'ignore' });
             monaco.languages.setMonarchTokensProvider('ignore', {
                tokenizer: {
                    root: [
                        [/^#.*$/, 'comment'],
                        [/^!.*$/, 'string.escape'],
                        [/^\/.*$/, 'string.regexp'],
                    ]
                }
            });


            editor = monaco.editor.create(document.getElementById('editor-container'), { theme: 'vs-dark', automaticLayout: true, fontSize: 14, wordWrap: 'on', minimap: { enabled: true }, fontFamily: '"Roboto Mono", Consolas, "Courier New", monospace' });
            editor.getModel().onDidChangeContent(() => { if (currentOpenFile) { fileStore[currentOpenFile] = editor.getValue(); saveFileStoreToLocalStorage(); } });
            
            filesIcon.addEventListener('click', toggleSidebar);
            document.getElementById('add-file-btn').addEventListener('click', addNewFile);
            document.getElementById('create-file-welcome-btn').addEventListener('click', addNewFile);
            previewRemoveBtn.addEventListener('click', previewAndRemoveComments);

            const savedWidth = localStorage.getItem(SIDEBAR_WIDTH_KEY);
            if(savedWidth) sidebar.style.width = savedWidth;

            const lastFile = localStorage.getItem(LAST_OPEN_FILE_KEY);
            const files = Object.keys(fileStore);
            let fileToOpen = null;
            if (lastFile && fileStore[lastFile]) fileToOpen = lastFile;
            else if (files.length > 0) fileToOpen = files[0];
            
            openFile(fileToOpen);
        });
    </script>
</body>
</html>
